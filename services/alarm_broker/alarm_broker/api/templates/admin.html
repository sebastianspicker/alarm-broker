<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="refresh" content="${refresh_seconds}">
  <title>Alarm Operations Console</title>
  <style>
    :root {
      --ink: #0f172a;
      --paper: #f8f5ee;
      --panel: #fffefb;
      --accent: #005f73;
      --alert: #9b2226;
      --ok: #2a9d8f;
      --muted: #415a77;
      --line: #d6d3c9;
      --radius: 14px;
      --shadow: 0 18px 44px rgba(15, 23, 42, 0.08);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --ink: #e2e8f0;
        --paper: #0f172a;
        --panel: #1e293b;
        --accent: #38bdf8;
        --alert: #f87171;
        --ok: #4ade80;
        --muted: #94a3b8;
        --line: #334155;
        --shadow: 0 18px 44px rgba(0, 0, 0, 0.3);
      }
      .state { background: #334155; color: #e2e8f0; }
      .state.triggered { background: #7f1d1d; color: #fecaca; }
      .state.acknowledged { background: #164e63; color: #a5f3fc; }
      .state.resolved { background: #14532d; color: #bbf7d0; }
      .state.cancelled { background: #1f2937; color: #d1d5db; }
      th { background: #1e293b; }
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--ink);
      background:
        radial-gradient(circle at 15% 10%, rgba(0,95,115,0.12), transparent 42%),
        radial-gradient(circle at 85% 80%, rgba(155,34,38,0.10), transparent 45%),
        var(--paper);
      font-family: "Avenir Next", "Trebuchet MS", sans-serif;
      min-height: 100vh;
      padding: 18px;
    }
    .shell {
      max-width: 1120px;
      margin: 0 auto;
      display: grid;
      gap: 16px;
    }
    .hero {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
      box-shadow: var(--shadow);
      padding: 20px;
    }
    .title {
      margin: 0 0 8px;
      font-family: "Iowan Old Style", "Palatino Linotype", serif;
      letter-spacing: 0.02em;
      font-size: clamp(1.4rem, 3vw, 2.1rem);
    }
    .meta {
      margin: 0;
      color: var(--muted);
      font-size: 0.95rem;
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }
    .card {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--panel);
      padding: 12px;
    }
    .card h3 {
      margin: 0;
      color: var(--muted);
      font-size: 0.82rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .card p {
      margin: 8px 0 0;
      font-size: 1.5rem;
      font-weight: 700;
    }
    .table-wrap {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
      box-shadow: var(--shadow);
      overflow: auto;
    }
    .sim-panel {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--panel);
      box-shadow: var(--shadow);
      padding: 12px;
      display: grid;
      gap: 8px;
    }
    .sim-head h2 {
      margin: 0;
      font-family: "Iowan Old Style", "Palatino Linotype", serif;
      font-size: 1.1rem;
    }
    .sim-head p {
      margin: 4px 0 0;
    }
    .sim-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--panel);
      box-shadow: var(--shadow);
      padding: 12px;
      flex-wrap: wrap;
    }
    .search-input {
      width: min(440px, 100%);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      background: #fff;
      color: var(--ink);
      font: inherit;
    }
    .search-input:focus {
      outline: 2px solid rgba(0, 95, 115, 0.3);
      border-color: var(--accent);
    }
    .hint {
      color: var(--muted);
      font-size: 0.82rem;
    }
    .error-banner {
      border: 1px solid color-mix(in srgb, var(--alert) 45%, white);
      background: color-mix(in srgb, var(--alert) 14%, white);
      color: var(--alert);
      border-radius: 10px;
      padding: 10px 12px;
      font-weight: 600;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1080px;
      font-family: "SF Mono", Menlo, Monaco, monospace;
      font-size: 0.84rem;
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #f2efe7;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .state {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 8px;
      font-weight: 700;
      font-size: 0.76rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      background: #eef2ff;
      color: #1e3a8a;
    }
    .state.triggered { background: #fef2f2; color: var(--alert); }
    .state.acknowledged { background: #ecfeff; color: var(--accent); }
    .state.resolved { background: #ecfdf3; color: #166534; }
    .state.cancelled { background: #f3f4f6; color: #374151; }
    .actions {
      white-space: nowrap;
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }
    .btn {
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #f8fafc;
      color: var(--ink);
      padding: 6px 10px;
      font: inherit;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.1);
      background: #ffffff;
    }
    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.45;
      transform: none;
      box-shadow: none;
    }
    .btn.btn-ack {
      border-color: color-mix(in srgb, var(--accent) 32%, var(--line));
      color: var(--accent);
      background: color-mix(in srgb, var(--accent) 10%, white);
    }
    .btn.btn-resolve {
      border-color: color-mix(in srgb, var(--ok) 36%, var(--line));
      color: #0f5132;
      background: color-mix(in srgb, var(--ok) 14%, white);
    }
    .row-hidden {
      display: none;
    }
    .modal {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      z-index: 30;
    }
    .modal[hidden] {
      display: none;
    }
    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      backdrop-filter: blur(2px);
    }
    .modal-panel {
      position: relative;
      z-index: 1;
      width: min(640px, calc(100vw - 24px));
      max-height: calc(100vh - 40px);
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: var(--panel);
      box-shadow: var(--shadow);
      padding: 16px;
      display: grid;
      gap: 12px;
    }
    .modal-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    .modal-title {
      margin: 0;
      font-family: "Iowan Old Style", "Palatino Linotype", serif;
      font-size: 1.2rem;
    }
    .close-btn {
      border-radius: 10px;
      min-width: 34px;
      min-height: 34px;
      padding: 0;
    }
    .detail-grid {
      margin: 0;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
    }
    .detail-grid dt {
      margin: 0;
      color: var(--muted);
      font-weight: 700;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .detail-grid dd {
      margin: 0;
      font-family: "SF Mono", Menlo, Monaco, monospace;
      word-break: break-word;
    }
    .modal-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .muted { color: var(--muted); }
    @media (max-width: 880px) {
      .cards { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      body { padding: 10px; }
      .hero { padding: 14px; }
      .detail-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="shell">
    <section class="hero">
      <h1 class="title">Alarm Operations Console</h1>
      <p class="meta">
        <span>Auto-refresh: ${refresh_seconds}s</span>
        <span>Rows: ${row_count}</span>
        <span>Updated: ${generated_at}</span>
      </p>
    </section>
    <section class="cards">
      ${status_cards}
    </section>
    ${simulation_panel}
    <section class="toolbar">
      <input id="alarm-search" class="search-input" type="search" placeholder="Search alarm id, person, room, source, severity..." aria-label="Search alarms">
      <span id="search-hint" class="hint">Type to filter visible rows</span>
    </section>
    <div id="error-banner" class="error-banner" role="alert" hidden></div>
    <section class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Status</th>
            <th>Alarm ID</th>
            <th>Created</th>
            <th>Person</th>
            <th>Room</th>
            <th>Source</th>
            <th>Severity</th>
            <th>Ack</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>
    </section>
  </main>

  <div id="alarm-detail-modal" class="modal" aria-hidden="true" hidden>
    <div class="modal-backdrop" data-close-modal="true"></div>
    <section class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="detail-modal-title">
      <header class="modal-header">
        <div>
          <h2 id="detail-modal-title" class="modal-title">Alarm Details</h2>
          <p id="detail-modal-subtitle" class="muted">No alarm selected</p>
        </div>
        <button type="button" class="btn close-btn" data-close-modal="true" aria-label="Close details">Ã—</button>
      </header>
      <dl class="detail-grid">
        <dt>Alarm ID</dt><dd id="detail-alarm-id">-</dd>
        <dt>Status</dt><dd id="detail-status">-</dd>
        <dt>Created</dt><dd id="detail-created">-</dd>
        <dt>Person</dt><dd id="detail-person">-</dd>
        <dt>Room</dt><dd id="detail-room">-</dd>
        <dt>Source</dt><dd id="detail-source">-</dd>
        <dt>Severity</dt><dd id="detail-severity">-</dd>
        <dt>Acked By</dt><dd id="detail-acked-by">-</dd>
      </dl>
      <div class="modal-actions">
        <button id="detail-ack-btn" type="button" class="btn btn-ack">Quick Ack</button>
        <button id="detail-resolve-btn" type="button" class="btn btn-resolve">Quick Resolve</button>
        <button type="button" class="btn" data-close-modal="true">Close</button>
      </div>
    </section>
  </div>

  <script>
    const ADMIN_API_KEY = ${admin_key_json};
    const modalElement = document.getElementById('alarm-detail-modal');
    const errorElement = document.getElementById('error-banner');
    const searchInput = document.getElementById('alarm-search');
    const searchHint = document.getElementById('search-hint');
    const simulationPanel = document.getElementById('simulation-panel');
    const simulationStatus = document.getElementById('sim-status');
    const simulationCount = document.getElementById('sim-count');
    const simulationRefreshBtn = document.getElementById('sim-refresh-btn');
    const simulationClearBtn = document.getElementById('sim-clear-btn');
    const simulationSeedBtn = document.getElementById('sim-seed-btn');
    const modalSubtitle = document.getElementById('detail-modal-subtitle');
    const detailAckBtn = document.getElementById('detail-ack-btn');
    const detailResolveBtn = document.getElementById('detail-resolve-btn');
    const modalState = { alarmId: null };

    function showError(message) {
      errorElement.textContent = message;
      errorElement.hidden = false;
      window.clearTimeout(showError.timeoutId);
      showError.timeoutId = window.setTimeout(() => {
        errorElement.hidden = true;
      }, 6000);
    }

    function setDetailField(id, value) {
      const target = document.getElementById(id);
      target.textContent = value || '-';
    }

    function setButtonStateFromRow(row) {
      const canAck = row.dataset.canAck === 'true';
      const canResolve = row.dataset.canResolve === 'true';
      detailAckBtn.disabled = !canAck;
      detailResolveBtn.disabled = !canResolve;
    }

    function openDetailModal(row) {
      modalState.alarmId = row.dataset.alarmId || null;
      modalSubtitle.textContent = 'Alarm ' + (row.dataset.shortId || row.dataset.alarmId || '-');
      setDetailField('detail-alarm-id', row.dataset.alarmId);
      setDetailField('detail-status', row.dataset.status);
      setDetailField('detail-created', row.dataset.created);
      setDetailField('detail-person', row.dataset.person);
      setDetailField('detail-room', row.dataset.room);
      setDetailField('detail-source', row.dataset.source);
      setDetailField('detail-severity', row.dataset.severity);
      setDetailField('detail-acked-by', row.dataset.ackedBy);
      setButtonStateFromRow(row);
      modalElement.hidden = false;
      modalElement.setAttribute('aria-hidden', 'false');
    }

    function closeDetailModal() {
      modalState.alarmId = null;
      modalElement.hidden = true;
      modalElement.setAttribute('aria-hidden', 'true');
    }

    async function postAction(path, payload) {
      const headers = { 'Content-Type': 'application/json' };
      if (ADMIN_API_KEY) {
        headers['X-Admin-Key'] = ADMIN_API_KEY;
      }
      const response = await fetch(path, {
        method: 'POST',
        headers,
        body: JSON.stringify(payload),
      });

      if (!response.ok) {
        let detail = 'Unexpected request error';
        try {
          const data = await response.json();
          if (data && typeof data.detail === 'string') {
            detail = data.detail;
          }
        } catch (ignore) {}
        throw new Error(detail + ' (HTTP ' + response.status + ')');
      }
    }

    async function fetchSimulation(path, options) {
      const headers = { 'Content-Type': 'application/json' };
      if (ADMIN_API_KEY) {
        headers['X-Admin-Key'] = ADMIN_API_KEY;
      }
      const response = await fetch(path, Object.assign({ headers }, options || {}));
      if (!response.ok) {
        throw new Error('Simulation request failed (HTTP ' + response.status + ')');
      }
      return await response.json();
    }

    function setSimulationBusy(isBusy) {
      if (!simulationRefreshBtn || !simulationClearBtn || !simulationSeedBtn) {
        return;
      }
      simulationRefreshBtn.disabled = isBusy;
      simulationClearBtn.disabled = isBusy;
      simulationSeedBtn.disabled = isBusy;
    }

    async function refreshSimulationStatus() {
      if (!simulationPanel || simulationPanel.dataset.enabled !== 'true') {
        return;
      }
      setSimulationBusy(true);
      try {
        const statusData = await fetchSimulation('/v1/simulation/status');
        simulationStatus.textContent = 'Simulation enabled. Channels: '
          + 'zammad=' + statusData.by_channel.zammad
          + ', sms=' + statusData.by_channel.sms
          + ', signal=' + statusData.by_channel.signal;
        simulationCount.textContent = String(statusData.total_notifications);
      } catch (error) {
        showError(error.message || 'Simulation status failed');
      } finally {
        setSimulationBusy(false);
      }
    }

    async function acknowledgeAlarm(alarmId) {
      const ackedBy = window.prompt('Acked by', 'Admin UI');
      if (ackedBy === null) {
        return;
      }
      await postAction('/v1/alarms/' + encodeURIComponent(alarmId) + '/ack', {
        acked_by: ackedBy || 'Admin UI',
      });
    }

    async function resolveAlarm(alarmId) {
      const actor = window.prompt('Resolved by', 'Admin UI');
      if (actor === null) {
        return;
      }
      await postAction('/v1/alarms/' + encodeURIComponent(alarmId) + '/resolve', {
        actor: actor || 'Admin UI',
      });
    }

    function runSearchFilter() {
      const query = (searchInput.value || '').trim().toLowerCase();
      const rows = document.querySelectorAll('tr.alarm-row');
      let visible = 0;
      rows.forEach((row) => {
        const haystack = (row.dataset.search || row.textContent || '').toLowerCase();
        const isMatch = !query || haystack.includes(query);
        row.classList.toggle('row-hidden', !isMatch);
        if (isMatch) {
          visible += 1;
        }
      });
      searchHint.textContent = visible + ' matching rows';
    }

    document.addEventListener('click', async (event) => {
      const closeTarget = event.target.closest('[data-close-modal="true"]');
      if (closeTarget) {
        closeDetailModal();
        return;
      }

      const detailButton = event.target.closest('.detail-btn');
      if (detailButton) {
        openDetailModal(detailButton.closest('tr.alarm-row'));
        return;
      }

      const ackButton = event.target.closest('.quick-ack-btn');
      if (ackButton) {
        const row = ackButton.closest('tr.alarm-row');
        try {
          await acknowledgeAlarm(row.dataset.alarmId);
          window.location.reload();
        } catch (error) {
          showError(error.message || 'Acknowledge failed');
        }
        return;
      }

      const resolveButton = event.target.closest('.quick-resolve-btn');
      if (resolveButton) {
        const row = resolveButton.closest('tr.alarm-row');
        try {
          await resolveAlarm(row.dataset.alarmId);
          window.location.reload();
        } catch (error) {
          showError(error.message || 'Resolve failed');
        }
      }
    });

    detailAckBtn.addEventListener('click', async () => {
      if (!modalState.alarmId) {
        return;
      }
      try {
        await acknowledgeAlarm(modalState.alarmId);
        window.location.reload();
      } catch (error) {
        showError(error.message || 'Acknowledge failed');
      }
    });

    detailResolveBtn.addEventListener('click', async () => {
      if (!modalState.alarmId) {
        return;
      }
      try {
        await resolveAlarm(modalState.alarmId);
        window.location.reload();
      } catch (error) {
        showError(error.message || 'Resolve failed');
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && !modalElement.hidden) {
        closeDetailModal();
      }
    });

    searchInput.addEventListener('input', runSearchFilter);
    runSearchFilter();

    if (simulationPanel && simulationPanel.dataset.enabled === 'true') {
      simulationRefreshBtn.addEventListener('click', async () => {
        await refreshSimulationStatus();
      });
      simulationClearBtn.addEventListener('click', async () => {
        setSimulationBusy(true);
        try {
          await fetchSimulation('/v1/simulation/notifications/clear', { method: 'POST' });
          await refreshSimulationStatus();
        } catch (error) {
          showError(error.message || 'Clearing simulation notifications failed');
        } finally {
          setSimulationBusy(false);
        }
      });
      simulationSeedBtn.addEventListener('click', async () => {
        setSimulationBusy(true);
        try {
          const seedInfo = await fetchSimulation('/v1/simulation/seed', { method: 'POST' });
          simulationStatus.textContent = 'Seed helper available: ' + seedInfo.seed_file;
        } catch (error) {
          showError(error.message || 'Simulation seed info failed');
        } finally {
          setSimulationBusy(false);
        }
      });
      refreshSimulationStatus();
    }
  </script>
</body>
</html>
